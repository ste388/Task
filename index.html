<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestore Pratiche (Vocale)</title>
    <style>
        /* --- STILE BASE --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f0f2f5; color: #333; margin: 0; padding: 10px; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .container { 
            max-width: 800px; margin: 0 auto; background: white; 
            padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }

        h1 { font-size: 1.5rem; text-align: center; color: #2c3e50; margin: 10px 0 20px 0; }

        /* INPUT PRINCIPALE */
        .input-group { 
            display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; 
            background: #eef2f5; padding: 15px; border-radius: 12px;
        }
        input, button { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 16px; box-sizing: border-box; 
        }
        
        /* BOTTONI FORM */
        .btn-row { display: flex; gap: 10px; width: 100%; }
        #btnMain { background-color: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; flex: 1; }
        #btnMic { background-color: #8e44ad; color: white; border: none; font-weight: bold; cursor: pointer; flex: 1; transition: 0.3s;}
        #btnCancel { background-color: #7f8c8d; color: white; border: none; font-weight: bold; display: none; cursor: pointer; }

        /* LISTA TASK */
        ul { list-style: none; padding: 0; margin: 0; }
        
        li { 
            background: #fff; border-bottom: 1px solid #eee; padding: 15px; margin-bottom: 10px;
            border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; 
        }

        .task-header { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        .task-info { flex: 1; padding-right: 10px; }
        .task-title { font-size: 18px; font-weight: 600; display: block; margin-bottom: 5px; }
        .task-meta { font-size: 13px; color: #666; display: block; margin-bottom: 5px; line-height: 1.4;}

        /* ANTEPRIMA ULTIMA NOTA */
        .latest-note-preview {
            background-color: #f8f9fa; border-left: 4px solid #3498db; 
            padding: 8px 12px; margin-top: 10px; font-size: 14px;
            color: #444; border-radius: 0 6px 6px 0; width: 100%;
            box-sizing: border-box; cursor: pointer; 
        }
        .latest-note-date { font-weight: bold; font-size: 11px; color: #3498db; text-transform: uppercase; margin-right: 5px; }

        /* PULSANTI AZIONI TASK */
        .task-actions { display: flex; gap: 8px; margin-top: 5px; } 
        .btn-action { 
            width: 40px; height: 40px; border-radius: 8px; border: none; color: white;
            font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        .status-ok { border-left: 6px solid #27ae60; }
        .status-warning { border-left: 6px solid #f1c40f; background-color: #fffbf0; }
        .status-danger { border-left: 6px solid #e74c3c; background-color: #fff5f5; }
        .status-done { border-left: 6px solid #95a5a6; opacity: 0.7; }
        .status-done .task-title { text-decoration: line-through; }

        .btn-edit { background-color: #f39c12; }
        .btn-log { background-color: #3498db; }
        .btn-done { background-color: #27ae60; }
        .btn-del { background-color: #e74c3c; }

        /* --- MODALE --- */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 999; align-items: center; justify-content: center; 
            padding: 15px; box-sizing: border-box;
        }
        
        .modal-content { 
            background: white; padding: 25px; width: 100%; max-width: 800px; 
            border-radius: 12px; display: flex; flex-direction: column; max-height: 85vh; 
        }
        #modalTitle { margin-top: 0; margin-bottom: 15px; color: #2c3e50; font-size: 1.2rem;}

        .log-history { 
            flex: 1; overflow-y: auto; margin-bottom: 15px; 
            border: 1px solid #ddd; padding: 15px; border-radius: 8px;
            background: #fdfdfd; display: block; width: 100%; box-sizing: border-box;
        }
        
        .log-entry { 
            padding: 15px 0; border-bottom: 1px solid #eee; 
            display: flex; flex-direction: column; width: 100%; box-sizing: border-box;
        }
        .log-entry:last-child { border-bottom: none; padding-bottom: 0;}
        
        .log-text-container { width: 100%; margin-bottom: 10px; }
        .log-date-label { color:#7f8c8d; font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;}
        .log-text-content { font-size: 15px; line-height: 1.5; color: #222; width: 100%; word-wrap: break-word; }

        .log-actions-bar { display: flex; justify-content: flex-end; gap: 15px; width: 100%; }

        .btn-log-action {
            background: none; border: none; font-size: 13px; font-weight: bold; cursor: pointer; padding: 5px 10px; border-radius: 4px; display: flex; align-items: center; gap: 5px;
        }
        .btn-log-edit { color: #f39c12; }
        .btn-log-del { color: #e74c3c; }

        .new-log-group { display: flex; flex-direction: column; gap: 10px; background: #eef2f5; padding: 15px; border-radius: 8px;}
        .new-log-group input { width: 100%; border: 1px solid #ccc; }
        .new-log-group button { width: 100%; padding: 12px; border-radius: 8px; color: white; border: none; font-weight: bold; background: #3498db; cursor: pointer;}

        @media (min-width: 601px) {
            .input-group { flex-direction: row; flex-wrap: wrap; align-items: flex-end; }
            .input-group > input { flex: 1; }
            .btn-row { width: auto; }
        }

        @media (max-width: 600px) {
            .task-header { flex-direction: column; }
            .task-actions { width: 100%; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;}
            .btn-action { flex-grow: 1; margin: 0 3px; height: 45px; }
            #exportContainer { display: none !important; }
            .modal-content { padding: 15px; }
        }
    </style>

    <!-- FIREBASE E SHEETJS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="container">
    <h1>üèõÔ∏è Pratiche Comune (Cloud)</h1>

    <div id="exportContainer" style="text-align:right; margin-bottom:10px;">
        <button onclick="esportaXLS()" style="background:#16a085; color:white; border:none; padding:8px 15px; border-radius:6px; font-size:14px; cursor:pointer; width:auto;">
            ‚¨áÔ∏è Esporta in XLS
        </button>
    </div>

    <!-- Area Inserimento con Tasto Vocale -->
    <div class="input-group">
        <input type="text" id="taskInput" placeholder="Cosa devi fare?" onkeypress="seInvio(event)">
        <input type="datetime-local" id="dateInput">
        <div class="btn-row">
            <button id="btnMain" onclick="gestisciSalvataggio()">AGGIUNGI</button>
            <button id="btnMic" onclick="avviaAscolto()">üé§ DETTA</button>
        </div>
        <button id="btnCancel" onclick="annullaModifica()">ANNULLA MODIFICA</button>
    </div>

    <div id="loading" style="text-align:center; color:#666; padding:20px;">‚è≥ Caricamento dati...</div>
    <ul id="listaTask"></ul>
</div>

<!-- Modale Storia -->
<div id="modalLog" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Storico Aggiornamenti</h3>
        <div class="log-history" id="logHistoryContainer"></div>
        <div class="new-log-group">
            <span id="logEditLabel" style="display:none; color:#f39c12; font-weight:bold; font-size:13px;">Stai modificando una nota:</span>
            <input type="text" id="newLogInput" placeholder="Scrivi un aggiornamento qui...">
            <div style="display:flex; gap:10px; width:100%;">
                <button id="btnSalvaLog" onclick="salvaLog()">SALVA</button>
                <button id="btnAnnullaLog" onclick="annullaModificaLog()" style="display:none; background:#7f8c8d;">ANNULLA</button>
            </div>
        </div>
        <button onclick="chiudiModal()" style="margin-top:15px; padding:12px; background: #e0e0e0; color: #333; font-weight: bold; border:none; border-radius:8px; cursor:pointer; width: 100%;">CHIUDI FINESTRA</button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAL97hOMZQ1-Jr6pFUpu23QiJRuLbrUtcg",
      authDomain: "task-27d22.firebaseapp.com",
      projectId: "task-27d22",
      storageBucket: "task-27d22.firebasestorage.app",
      messagingSenderId: "949506308246",
      appId: "1:949506308246:web:9de5575e3afff3ef55eab7"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    const collectionName = "promemoria_comune"; 

    let tasks = [];
    let currentLogId = null; 
    let editingTaskId = null; 
    let editingLogIndex = null; 

    db.collection(collectionName).onSnapshot((querySnapshot) => {
        tasks = [];
        querySnapshot.forEach((doc) => {
            let data = doc.data();
            data.id = doc.id; 
            tasks.push(data);
        });
        document.getElementById('loading').style.display = 'none';
        renderTasks();
        
        if(currentLogId && document.getElementById('modalLog').style.display === 'flex') {
             apriLog(currentLogId, false);
        }
    });

    setInterval(cicloControllo, 60000); 

    // --- FUNZIONE ESTERNA PER CREARE TASK NEL DB ---
    function creaTaskDB(testo, scadenza = "") {
        const dataOggi = new Date().toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        db.collection(collectionName).add({
            text: testo, 
            deadline: scadenza, 
            dataInserimento: dataOggi, 
            timestamp: Date.now(), 
            done: false, 
            notified: false, 
            logs: [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.getElementById('taskInput').value = '';
            document.getElementById('dateInput').value = '';
        });
    }

    function gestisciSalvataggio() {
        const testo = document.getElementById('taskInput').value.trim();
        const data = document.getElementById('dateInput').value;

        if (testo === '') { alert("Inserisci il nome!"); return; }

        if (editingTaskId) {
            db.collection(collectionName).doc(editingTaskId).update({
                text: testo, deadline: data, notified: false 
            }).then(() => annullaModifica());
        } else {
            if (data === '' && !confirm("Salvare senza scadenza?")) return;
            creaTaskDB(testo, data);
        }
    }

    // ==========================================
    // SISTEMA VOCALE (SPEECH RECOGNITION MODIFICATO)
    // ==========================================
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'it-IT';
        recognition.continuous = false; 

        recognition.onstart = function() {
            const btn = document.getElementById('btnMic');
            btn.innerHTML = "üî¥ ASCOLTO...";
            btn.style.backgroundColor = "#e74c3c"; // Rosso durante l'ascolto
        };

        recognition.onresult = function(event) {
            let trascrizione = event.results[0][0].transcript.trim();
            let trascrizioneLower = trascrizione.toLowerCase();
            let nuovoTitolo = trascrizione;

            // Rimuove eventuali comandi pronunciati per abitudine dall'utente
            const triggerWords = ["inserisci nuovo task", "inserisci task", "aggiungi nuovo task", "aggiungi task", "nuovo task"];
            
            for(let trigger of triggerWords) {
                if(trascrizioneLower.startsWith(trigger)) {
                    nuovoTitolo = trascrizione.substring(trigger.length).trim();
                    break;
                }
            }

            // Pulisce punteggiatura all'inizio (es. se rimuovendo la parola rimane ", chiamare sindaco")
            nuovoTitolo = nuovoTitolo.replace(/^[,.:;]\s*/, '').trim();

            if (nuovoTitolo === "") {
                alert("Non ho sentito il titolo della pratica. Riprova.");
            } else {
                // Mette la prima lettera in maiuscolo
                nuovoTitolo = nuovoTitolo.charAt(0).toUpperCase() + nuovoTitolo.slice(1);
                
                // SALVATAGGIO DIRETTO
                creaTaskDB(nuovoTitolo, ""); 
            }
        };

        recognition.onend = function() {
            const btn = document.getElementById('btnMic');
            btn.innerHTML = "üé§ DETTA";
            btn.style.backgroundColor = "#8e44ad"; // Torna viola
        };

        recognition.onerror = function(event) {
            if(event.error !== "no-speech") { // Evita alert se c'√® solo silenzio
                alert("Errore riconoscimento vocale: " + event.error);
            }
            const btn = document.getElementById('btnMic');
            btn.innerHTML = "üé§ DETTA";
            btn.style.backgroundColor = "#8e44ad";
        };
    }

    function avviaAscolto() {
        if (recognition) {
            try {
                recognition.start();
            } catch(e) {
                console.log("Gi√† in ascolto");
            }
        } else {
            alert("Il tuo browser non supporta il microfono per questa funzione. Usa Chrome.");
        }
    }
    // ==========================================

    function cicloControllo() {
        renderTasks(); 
        const now = new Date(); let suona = false;
        tasks.forEach(t => {
            if(!t.done && t.deadline) {
                const diff = (new Date(t.deadline) - now) / 60000;
                if(diff > 0 && diff <= 30 && !t.notified) {
                    suona = true; db.collection(collectionName).doc(t.id).update({ notified: true });
                }
            }
        });
        if(suona) playBeep();
    }

    function renderTasks() {
        const lista = document.getElementById('listaTask');
        lista.innerHTML = '';

        tasks.sort((a, b) => {
            if (a.done !== b.done) return a.done ? 1 : -1;
            function getSortTime(t) {
                if (t.timestamp) return t.timestamp; 
                if (t.createdAt && typeof t.createdAt.toMillis === 'function') return t.createdAt.toMillis();
                if (t.dataInserimento) {
                    const match = t.dataInserimento.match(/(\d{2})\/(\d{2})\/(\d{4}),\s?(\d{2}):(\d{2})/);
                    if (match) return new Date(match[3], match[2]-1, match[1], match[4], match[5]).getTime();
                }
                return 0; 
            }
            return getSortTime(b) - getSortTime(a);
        });

        tasks.forEach(task => {
            const li = document.createElement('li');
            let statusClass = 'status-ok'; let scadenzaTesto = 'Nessuna';
            
            if (task.done) { statusClass = 'status-done'; scadenzaTesto = 'Fatto'; } 
            else if (task.deadline) {
                const now = new Date(); const scad = new Date(task.deadline);
                const diffOre = (scad - now) / (1000 * 60 * 60);
                scadenzaTesto = scad.toLocaleString('it-IT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                if (diffOre < 0) statusClass = 'status-danger'; else if (diffOre < 48) statusClass = 'status-warning'; 
            }

            let dataCreazione = task.dataInserimento || (new Date().toLocaleString('it-IT', {day: '2-digit', month: '2-digit', year: 'numeric'}) + " (Stimata)");
            let lastLogHtml = ''; let logsCount = task.logs ? task.logs.length : 0;
            
            if (logsCount > 0) {
                const lastLog = task.logs[task.logs.length - 1]; 
                lastLogHtml = `
                    <div class="latest-note-preview" onclick="apriLog('${task.id}', true)">
                        <span class="latest-note-date">üìù ${lastLog.date}:</span>
                        ${lastLog.text}
                    </div>
                `;
            }

            li.className = statusClass;
            li.innerHTML = `
                <div class="task-header">
                    <div class="task-info">
                        <span class="task-title">${task.text}</span>
                        <span class="task-meta">
                            ‚ûï Inserita: ${dataCreazione}<br>
                            ${task.deadline ? '‚è≥ Scade: ' + scadenzaTesto : '‚ö™ Nessuna scadenza'} 
                             ‚Ä¢ <b>${logsCount}</b> Note
                        </span>
                    </div>
                    
                    <div class="task-actions">
                        <button class="btn-action btn-log" onclick="apriLog('${task.id}', true)">üìù</button>
                        <button class="btn-action btn-edit" onclick="avviaModifica('${task.id}')">‚úèÔ∏è</button>
                        <button class="btn-action btn-done" onclick="toggleDone('${task.id}', ${task.done})">‚úÖ</button>
                        <button class="btn-action btn-del" onclick="eliminaTask('${task.id}')">üóëÔ∏è</button>
                    </div>
                </div>
                ${lastLogHtml} 
            `;
            lista.appendChild(li);
        });
    }

    function avviaModifica(id) {
        const task = tasks.find(t => t.id === id); if (!task) return;
        document.getElementById('taskInput').value = task.text; document.getElementById('dateInput').value = task.deadline || '';
        editingTaskId = id;
        document.getElementById('btnMain').innerText = "SALVA MODIFICA"; 
        document.getElementById('btnMain').style.backgroundColor = "#f39c12"; 
        document.getElementById('btnMic').style.display = "none"; 
        document.getElementById('btnCancel').style.display = "block"; window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function annullaModifica() {
        editingTaskId = null; document.getElementById('taskInput').value = ''; document.getElementById('dateInput').value = '';
        document.getElementById('btnMain').innerText = "AGGIUNGI"; 
        document.getElementById('btnMain').style.backgroundColor = "#27ae60"; 
        document.getElementById('btnMic').style.display = "block"; 
        document.getElementById('btnCancel').style.display = "none";
    }

    function apriLog(id, showModal) {
        currentLogId = id;
        const task = tasks.find(t => t.id === id);
        if(!task) return;
        
        document.getElementById('modalTitle').innerText = task.text;
        const container = document.getElementById('logHistoryContainer');
        container.innerHTML = '';
        annullaModificaLog(); 

        const logs = task.logs || [];
        if(logs.length === 0) {
            container.innerHTML = '<div style="color:#999; text-align:center; padding: 20px;">Nessun aggiornamento registrato.</div>';
        } else {
            logs.map((log, index) => ({ log, originalIndex: index })).reverse().forEach(item => {
                container.innerHTML += `
                    <div class="log-entry">
                        <div class="log-text-container">
                            <span class="log-date-label">${item.log.date}</span>
                            <div class="log-text-content">${item.log.text}</div>
                        </div>
                        <div class="log-actions-bar">
                            <button class="btn-log-action btn-log-edit" onclick="preparaModificaLog(${item.originalIndex}, \`${item.log.text.replace(/'/g, "\\'")}\`)">‚úèÔ∏è Modifica</button>
                            <button class="btn-log-action btn-log-del" onclick="eliminaLog('${id}', ${item.originalIndex})">üóëÔ∏è Elimina</button>
                        </div>
                    </div>`;
            });
        }
        if(showModal) document.getElementById('modalLog').style.display = 'flex';
    }

    function salvaLog() {
        const txt = document.getElementById('newLogInput').value.trim();
        if(!txt) { alert("Scrivi qualcosa prima di salvare."); return; }
        const taskRef = db.collection(collectionName).doc(currentLogId);

        if (editingLogIndex !== null) {
            const task = tasks.find(t => t.id === currentLogId);
            const newLogs = [...task.logs];
            newLogs[editingLogIndex].text = txt; 
            taskRef.update({ logs: newLogs }).then(() => annullaModificaLog());
        } else {
            const dataOggi = new Date().toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            const newLog = { date: dataOggi, text: txt };
            taskRef.update({ logs: firebase.firestore.FieldValue.arrayUnion(newLog) }).then(() => {
                document.getElementById('newLogInput').value = '';
                document.getElementById('logHistoryContainer').scrollTop = 0;
            });
        }
    }

    function preparaModificaLog(index, testoAttuale) {
        editingLogIndex = index; document.getElementById('newLogInput').value = testoAttuale;
        document.getElementById('btnSalvaLog').innerText = "AGGIORNA NOTA"; document.getElementById('btnSalvaLog').style.backgroundColor = "#f39c12";
        document.getElementById('btnAnnullaLog').style.display = "block"; document.getElementById('logEditLabel').style.display = "block";
        document.getElementById('newLogInput').focus();
    }

    function annullaModificaLog() {
        editingLogIndex = null; document.getElementById('newLogInput').value = '';
        document.getElementById('btnSalvaLog').innerText = "SALVA"; document.getElementById('btnSalvaLog').style.backgroundColor = "#3498db";
        document.getElementById('btnAnnullaLog').style.display = "none"; document.getElementById('logEditLabel').style.display = "none";
    }

    function eliminaLog(taskId, idx) {
        if(confirm("Vuoi davvero cancellare questo aggiornamento?")) {
            const task = tasks.find(t => t.id === taskId);
            const newLogs = [...task.logs]; newLogs.splice(idx, 1);
            db.collection(collectionName).doc(taskId).update({ logs: newLogs });
        }
    }

    function toggleDone(id, currentStatus) { db.collection(collectionName).doc(id).update({ done: !currentStatus }); }
    function eliminaTask(id) { if(confirm("Vuoi davvero eliminare questa pratica e tutti i suoi aggiornamenti?")) { db.collection(collectionName).doc(id).delete(); if (editingTaskId === id) annullaModifica(); } }
    
    function playBeep() { try { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(880, ctx.currentTime); o.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.5); } catch(e) {} }

    function esportaXLS() {
        if (!tasks || tasks.length === 0) { alert("Non ci sono pratiche."); return; }
        const rows = tasks.map(t => {
            let lastLogText = ""; let lastLogDate = "";
            if (t.logs && t.logs.length > 0) { const last = t.logs[t.logs.length - 1]; lastLogText = last.text || ""; lastLogDate = last.date || ""; }
            let dataIns = t.dataInserimento || (new Date().toLocaleString('it-IT', {day: '2-digit', month: '2-digit', year: 'numeric'}) + " (Stimata)");
            return { "Descrizione Pratica": t.text || "", "Data Inserimento": dataIns, "Scadenza": t.deadline ? new Date(t.deadline).toLocaleString('it-IT') : "Nessuna", "Stato": t.done ? "Completata" : "Aperta", "Note (Num)": t.logs ? t.logs.length : 0, "Data Ultima Nota": lastLogDate, "Testo Ultima Nota": lastLogText };
        });
        const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Pratiche");
        const oggi = new Date(); const yyyy = oggi.getFullYear(); const mm = String(oggi.getMonth() + 1).padStart(2, "0"); const dd = String(oggi.getDate()).padStart(2, "0");
        XLSX.writeFile(wb, `pratiche_comune_${yyyy}${mm}${dd}.xlsx`);
    }
    
    function chiudiModal() { document.getElementById('modalLog').style.display = 'none'; annullaModificaLog(); }
    function seInvio(e) { if(e.key==='Enter') gestisciSalvataggio(); }
    document.getElementById('newLogInput').addEventListener('keypress', function (e) { if (e.key === 'Enter') { salvaLog(); } });
    window.onclick = e => { if(e.target == document.getElementById('modalLog')) chiudiModal(); }
</script>
</body>
</html>
